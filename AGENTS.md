# AI First Skeleton — Agent Guidelines

> Canonical instructions for ALL AI coding agents (Codex, Gemini CLI, Cursor, Windsurf, Copilot, etc.)

## Architecture

Read `ARCHITECTURE.md` FIRST for the full architecture overview.

**Pattern:** Boundary Slices — each slice owns its schema, routes, service, and UI components.
**Paradigm:** Functional Core + Imperative Shell.
**Schema source of truth:** `packages/shared/src/slices/<name>/schemas.ts` (Zod).

## Monorepo Structure

```
packages/shared/     → Zod schemas (SINGLE SOURCE OF TRUTH)
apps/api/            → Hono backend (runs on Bun)
apps/web/            → React frontend (runs on Vite)
```

## Commands

| Task | Command |
|------|---------|
| Install deps | `pnpm install` |
| Dev (all) | `pnpm dev` |
| Dev API only | `pnpm dev:api` |
| Dev Web only | `pnpm dev:web` |
| Lint | `pnpm lint` |
| Lint + fix | `pnpm lint:fix` |
| Test (unit+integration) | `pnpm test` |
| Test (E2E) | `pnpm test:e2e` |
| Type check | `pnpm typecheck` |
| DB migrations | `pnpm db:generate && pnpm db:migrate` |
| DB seed | `pnpm db:seed` |
| Start PostgreSQL | `docker compose up -d` |
| Generate new slice | `pnpm generate:slice <name>` |
| OpenAPI spec (JSON) | `http://localhost:3001/doc` |
| Swagger UI | `http://localhost:3001/ui` |
| Install git hooks | `pnpm lefthook install` |
| Verify all guardrails | `pnpm verify` |
| Validate contracts | `pnpm validate:contracts` |

## Conventions

### Adding a new slice

**Full workflow:** See [`docs/workflows/add-slice.md`](docs/workflows/add-slice.md) for the complete step-by-step guide with Definition of Done.

Run `pnpm generate:slice <name>` to scaffold, then:

1. Edit Zod schemas in `packages/shared/src/slices/<name>/schemas.ts`
2. Export from `packages/shared/src/index.ts`
3. Add Drizzle table in `apps/api/src/db/schema.ts`
4. Implement `apps/api/src/slices/<name>/service.ts`
5. Implement `apps/api/src/slices/<name>/routes.ts` using `OpenAPIHono` + `createRoute()`
6. Register routes in `apps/api/src/app.ts` via `app.route()`
7. Wire hooks in `apps/web/src/slices/<name>/hooks/`
8. Build UI in `apps/web/src/slices/<name>/components/`
9. Run `pnpm db:generate && pnpm db:migrate`
10. Complete tests in `apps/api/src/slices/<name>/__tests__/routes.test.ts`
11. Run `pnpm verify` to validate everything

### Contract Testing (Verifier-First)

Contract tests verify that routes **exist** in the OpenAPI spec — no database, no handlers executed. They catch:
- Endpoint not implemented
- Slice not registered in `app.ts`
- Route definition missing from `routes.ts`

**Two levels of contract tests:**

1. **Global contract test** (`apps/api/src/__tests__/contracts.test.ts`) — verifies ALL slices in one test
2. **Per-slice contract test** (`apps/api/src/slices/<name>/__tests__/routes.contract.test.ts`) — verifies one slice, generated by `pnpm generate:slice`

Contract tests use `getOpenAPIDocument()` to extract route metadata from `createRoute()` definitions. No network calls, no DB setup.

**Run contract tests:**
```bash
pnpm validate:contracts          # Run global contract test
pnpm test                         # Runs all tests (includes contracts)
pnpm verify                       # Full validation (includes contracts)
```

**Pattern:**
```typescript
import { crudOperations, verifyOpenApiPaths } from '../lib/contract-testing'

const app = createApp()
const doc = app.getOpenAPIDocument({ openapi: '3.0.0', info: { title: 'Test', version: '0.0.0' } })
const operations = crudOperations('/api/todos')
const { missing } = verifyOpenApiPaths(doc, operations)
expect(missing).toHaveLength(0)
```

Contract tests run in **< 1 second** and are the first line of defense. If a contract test fails, the route is missing from the OpenAPI spec.

### E2E Testing (Playwright)

E2E tests verify **user journeys**, not individual operations. If you can test it with an integration test, do that instead — E2E is for flows that cross the full stack (browser → API → DB → UI feedback).

**File structure:** `e2e/<slice-or-journey>.spec.ts` at monorepo root (not inside `apps/`).

**DB isolation — API-based cleanup in `beforeEach`:**

```typescript
test.beforeEach(async ({ page, request }) => {
  const res = await request.get('http://localhost:3001/api/todos')
  const { data } = await res.json()
  for (const todo of data) {
    await request.delete(`http://localhost:3001/api/todos/${todo.id}`)
  }
  await page.goto('/')
})
```

Clean via API calls, not `TRUNCATE` — respects permissions, foreign keys, and auth middleware.

**Playwright config summary:**

| Setting | Value | Why |
|---------|-------|-----|
| `testDir` | `./e2e` | Monorepo root |
| `workers` | `1` | Shared DB — parallel tests cause flakiness |
| `retries` | `2` in CI, `0` local | Catch transient failures in CI |
| `trace` | `on-first-retry` | Debug flaky tests without perf overhead |
| `webServer` | Dual: API (port 3001) + Web (port 5174) | Full stack for E2E |
| `reporter` | `github` in CI, `list` local | Annotations on PR checks |

**Commands:**

| Task | Command |
|------|---------|
| Run E2E tests | `pnpm test:e2e` |
| Run with Playwright UI | `pnpm test:e2e:ui` |
| Debug a single test | `pnpm test:e2e -- --grep "test name"` |

**What to test in E2E:**

- Critical user journeys (CRUD flow, auth flow, form submission + validation feedback)
- Cross-slice interactions (creating entity A, then using it in entity B)
- Error states visible to users (validation errors, empty states, 404 pages)

**What NOT to test in E2E:**

- Individual API operations (use integration tests)
- Edge cases in business logic (use unit tests)
- Contract existence (use contract tests)

**Selectors:** Prefer `getByRole()`, `getByText()`, `getByPlaceholder()` over CSS selectors. Use `data-testid` only when semantic selectors are ambiguous.

### Rules

- **Read `INVARIANTS.md`** before making changes — these rules must never be broken
- **Schema-first:** Change the Zod schema first, then everything else follows
- **No any:** Use Zod inference (`z.infer<typeof schema>`) for all types. The ONLY escape: biome-ignore with library name and reason.
- **No process.env:** Import typed config from apps/api/src/env.ts. Only main.ts and seed.ts may access process.env directly.
- **No type assertions:** Never use `as any`, `as unknown as T`, or `as SomeType`. Use `satisfies` and `as const` instead. For Hono RPC query params, use `as Record<string, string>`.
- **Functional core:** Services are pure functions. No side effects in business logic.
- **Imperative shell:** Only `main.ts` may use runtime-specific APIs (no `Bun.*`/`Deno.*`/`process.*` elsewhere)
- **Slice isolation:** A slice may import from `@repo/shared` and its own slice only
- **Errors:** Throw `AppError.notFound()` etc. in services/routes — global handler catches them
- **Error responses in OpenAPI:** Only declare success responses in `createRoute()`. Error responses (404, 401, etc.) are produced by the global error handler, not individual route handlers. Declaring them in `createRoute()` causes type conflicts.
- **Date serialization:** Drizzle returns `Date` objects for timestamp columns. Use `sanitizeTimestamps()` from `@repo/shared` in services, or call `.toISOString()` manually. Zod schemas expect ISO strings.
- **Public vs auth routes:** Use the auth middleware exclude pattern in `apps/api/src/middleware/auth.ts`. Example: `exclude: ['/health', '/api/chat', '/api/auth/login', '/api/auth/register']`
- **Pagination:** All list endpoints accept `ListQuerySchema` and return `{ data, meta }`
- **Testing:** Every CRUD slice has contract tests + integration tests. See `apps/api/AGENTS.md` for the CRUD Test Matrix.
- **Tailwind only:** No CSS files. Use Tailwind theme tokens (not hardcoded colors). CVA for variants.
- **UI primitives:** Reusable components live in `apps/web/src/ui/` (shadcn/ui pattern, copy-paste owned)
- **v0 for UI generation:** Use [v0.dev](https://v0.dev) to generate shadcn/ui components. Always prompt with "React + Vite, NO Next.js, NO server components". Adapt imports from `@/components/ui/` to `@/ui/`.
- **Small files:** Max ~200 lines per file. Split if larger.
- **Always verify after changes:** Run `pnpm lint` (NOT just `pnpm typecheck`) after writing code. Biome enforces formatting rules (line length, JSX attribute style, argument wrapping) that `typecheck` does not catch. If lint fails, run `pnpm lint:fix` and commit the result.

### Cross-Cutting Concerns

Three levels of cross-cutting concerns, each with a clear modification path:

#### Level 1: HTTP-level (middleware)
Concerns like CORS, rate limiting, request ID, secure headers.
→ Add middleware in `apps/api/src/app.ts`. Zero changes to slices.

#### Level 2: Service-level (decorators)
Concerns like audit logging, event publishing, caching.
→ Create decorator in `packages/shared/src/service-utils.ts`
→ Wrap functions in each service: `export const createX = withAudit(_createX, 'entity')`
→ The generator produces services with decorators applied by default

**Why decorators, not middleware for service logic:** AI agents "forget" middleware exists when editing service files — the logic is invisible in the file being edited. Service decorators are VISIBLE at the call site, preventing accidental duplication.

#### Level 3: Schema-level
Concerns like new fields, new filters, new validations.
→ Add to shared schema in `packages/shared`
→ Update each service and route (irreducible work)
→ Pattern: start with shared schema, then services, then routes

#### Adding a new cross-cutting concern

1. Determine the level (HTTP, Service, or Schema)
2. For service-level: create a decorator in `packages/shared/src/service-utils.ts`
3. Apply to all existing slices (AI agents are the migration tool — read AGENTS.md, apply pattern, verify with `pnpm verify`)
4. Update the generator to include it by default for new slices

### Naming

- Files: `kebab-case.ts` / `kebab-case.tsx`
- Zod schemas: `camelCase` (e.g., `createTodoSchema`)
- Types: `PascalCase` (e.g., `CreateTodo`)
- DB tables: `snake_case` (e.g., `todos`)
- Routes: `/api/<slice-name>` (e.g., `/api/todos`)

### Git

- Branch: `feat/<ticket>-<description>` or `fix/<ticket>-<description>`
- Commits: Conventional Commits with slice scope: `feat(todos): add completion toggle`
- Trunk-based: short-lived branches, merge to `main`

## Stack

| Layer | Technology |
|-------|-----------|
| Runtime (API) | Bun |
| Framework (API) | Hono + OpenAPIHono (`@hono/zod-openapi`) |
| ORM | Drizzle + PostgreSQL |
| Validation | Zod |
| API Docs | OpenAPI 3.0 (auto-generated) + Swagger UI |
| Lint/Format | Biome |
| Git Hooks | Lefthook (pre-commit: lint + typecheck) |
| UI Framework | React 19 |
| Build Tool | Vite |
| Routing | TanStack Router |
| Data Fetching | TanStack Query + Hono RPC |
| Styles | Tailwind CSS + CVA |
| Forms | React Hook Form + Zod |
| Testing (unit) | Vitest |
| Testing (E2E) | Playwright |
| Security Scanning | Gitleaks (secrets) + Trivy (vulnerabilities) |
| UI Components | shadcn/ui (copy-paste owned, `src/ui/`) |
